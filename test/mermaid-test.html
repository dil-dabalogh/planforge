<!DOCTYPE html>
<html>
<head>
    <title>Mermaid Export Dependency Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; }
        textarea { width: 100%; height: 200px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Mermaid Export Dependency Test</h1>
    <button onclick="runTest()">Run Test</button>
    <div id="results"></div>

    <script src="../src/js/model.js"></script>
    <script src="../src/js/ui.js"></script>
    <script>
        function runTest() {
            const results = document.getElementById('results');
            results.innerHTML = '';

            // Create initial state
            const state = window.PlanForgeModel.createInitialState();
            const ui = window.PlanForgeUI.createUI(state);
            const now = window.PlanForgeModel.today();
            
            // Add initiatives with different levels
            const i1 = window.PlanForgeModel.addInitiative(state, { 
                name: 'Setup Infrastructure', 
                start: now, 
                end: window.PlanForgeModel.addDays(now, 3),
                level: 'Initiative'
            });
            const i2 = window.PlanForgeModel.addInitiative(state, { 
                name: 'Database Design', 
                start: window.PlanForgeModel.addDays(now, 4), 
                end: window.PlanForgeModel.addDays(now, 7),
                level: 'Epic'
            });
            const i3 = window.PlanForgeModel.addInitiative(state, { 
                name: 'API Development', 
                start: window.PlanForgeModel.addDays(now, 8), 
                end: window.PlanForgeModel.addDays(now, 12),
                level: 'Epic'
            });
            const i4 = window.PlanForgeModel.addInitiative(state, { 
                name: 'User Authentication', 
                start: window.PlanForgeModel.addDays(now, 13), 
                end: window.PlanForgeModel.addDays(now, 15),
                level: 'Story'
            });
            const i5 = window.PlanForgeModel.addInitiative(state, { 
                name: 'Project Launch', 
                start: window.PlanForgeModel.addDays(now, 16), 
                end: window.PlanForgeModel.addDays(now, 16),
                level: 'Story'
            });
            
            // Create dependencies
            window.PlanForgeModel.linkDependency(state, i1, i2); // Database Design depends on Setup Infrastructure
            window.PlanForgeModel.linkDependency(state, i2, i3); // API Development depends on Database Design
            window.PlanForgeModel.linkDependency(state, i3, i4); // User Authentication depends on API Development
            window.PlanForgeModel.linkDependency(state, i4, i5); // Project Launch depends on User Authentication
            
            const data = window.PlanForgeModel.getActiveData(state);
            
            addResult('Step 1: Test data created', 
                data.initiatives.length === 5 && data.dependencies.length === 4, 
                `Initiatives: ${data.initiatives.length}, Dependencies: ${data.dependencies.length}`);

            // Generate Mermaid export
            const mermaidCode = ui.generateMermaidGantt(state);
            
            addResult('Step 2: Mermaid code generated', 
                mermaidCode.includes('after') && mermaidCode.includes('Setup Infrastructure'), 
                `Generated ${mermaidCode.length} characters of Mermaid code`);

            // Display the generated Mermaid code
            addResult('Generated Mermaid Code', true, `
                <textarea readonly>${mermaidCode}</textarea>
            `);

            // Test specific dependency patterns
            const hasAfterSyntax = mermaidCode.includes('after');
            const hasMultipleDependencies = (mermaidCode.match(/after/g) || []).length >= 4;
            const hasProperTaskNames = mermaidCode.includes('Setup Infrastructure') && 
                                     mermaidCode.includes('Database Design') && 
                                     mermaidCode.includes('API Development');
            
            addResult('Step 3: Dependency syntax verification', 
                hasAfterSyntax && hasMultipleDependencies && hasProperTaskNames, 
                `After syntax: ${hasAfterSyntax}, Multiple dependencies: ${hasMultipleDependencies}, Task names: ${hasProperTaskNames}`);

            // Test milestone handling
            const hasMilestoneSyntax = mermaidCode.includes('milestone');
            addResult('Step 4: Milestone syntax verification', 
                hasMilestoneSyntax, 
                `Milestone syntax found: ${hasMilestoneSyntax}`);

            // Show dependency details
            addResult('Dependency Details', true, `
                <pre>Dependencies in data:
${JSON.stringify(data.dependencies, null, 2)}

Initiatives:
${JSON.stringify(data.initiatives.map(i => ({id: i.id, name: i.name, level: i.level})), null, 2)}</pre>
            `);
        }

        function addResult(title, passed, details) {
            const results = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result ' + (passed ? 'success' : 'error');
            resultDiv.innerHTML = `<strong>${title}:</strong> ${passed ? 'PASS' : 'FAIL'}<br><small>${details}</small>`;
            results.appendChild(resultDiv);
        }
    </script>
</body>
</html>
