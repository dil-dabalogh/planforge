<!DOCTYPE html>
<html>
<head>
    <title>Dependency Cloning Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Dependency Cloning Test</h1>
    <button onclick="runTest()">Run Test</button>
    <div id="results"></div>

    <script src="../src/js/model.js"></script>
    <script>
        function runTest() {
            const results = document.getElementById('results');
            results.innerHTML = '';

            // Create initial state
            const state = window.PlanForgeModel.createInitialState();
            const now = window.PlanForgeModel.today();
            
            // Add initiatives
            const i1 = window.PlanForgeModel.addInitiative(state, { 
                name: 'Task 1', 
                start: now, 
                end: window.PlanForgeModel.addDays(now, 5) 
            });
            const i2 = window.PlanForgeModel.addInitiative(state, { 
                name: 'Task 2', 
                start: window.PlanForgeModel.addDays(now, 6), 
                end: window.PlanForgeModel.addDays(now, 10) 
            });
            
            // Create dependency
            window.PlanForgeModel.linkDependency(state, i1, i2);
            
            const originalScenario = state.scenarios[0];
            const originalData = originalScenario.data;
            
            addResult('Step 1: Original scenario created', 
                originalData.dependencies.length === 1, 
                `Dependencies: ${originalData.dependencies.length}, Initiatives: ${originalData.initiatives.length}`);

            // Clone scenario
            window.PlanForgeModel.cloneActiveScenario(state);
            
            const clonedScenario = state.scenarios[1];
            const clonedData = clonedScenario.data;
            
            addResult('Step 2: Scenario cloned', 
                clonedData.dependencies.length === 1, 
                `Dependencies: ${clonedData.dependencies.length}, Initiatives: ${clonedData.initiatives.length}`);

            // Check if dependencies were properly mapped
            if (clonedData.dependencies.length > 0) {
                const originalDep = originalData.dependencies[0];
                const clonedDep = clonedData.dependencies[0];
                
                const originalFromItem = originalData.initiatives.find(i => i.id === originalDep.fromId);
                const originalToItem = originalData.initiatives.find(i => i.id === originalDep.toId);
                const clonedFromItem = clonedData.initiatives.find(i => i.id === clonedDep.fromId);
                const clonedToItem = clonedData.initiatives.find(i => i.id === clonedDep.toId);
                
                const mappingCorrect = originalFromItem && originalToItem && clonedFromItem && clonedToItem &&
                                     originalFromItem.name === clonedFromItem.name && 
                                     originalToItem.name === clonedToItem.name;
                
                addResult('Step 3: Dependency mapping verified', 
                    mappingCorrect, 
                    `Original: ${originalFromItem?.name} → ${originalToItem?.name}<br>
                     Cloned: ${clonedFromItem?.name} → ${clonedToItem?.name}`);
            } else {
                addResult('Step 3: Dependency mapping', false, 'No dependencies found in cloned scenario');
            }

            // Show detailed data
            addResult('Detailed Data', true, `
                <pre>Original Scenario:
${JSON.stringify(originalData, null, 2)}

Cloned Scenario:
${JSON.stringify(clonedData, null, 2)}</pre>
            `);
        }

        function addResult(title, passed, details) {
            const results = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result ' + (passed ? 'success' : 'error');
            resultDiv.innerHTML = `<strong>${title}:</strong> ${passed ? 'PASS' : 'FAIL'}<br><small>${details}</small>`;
            results.appendChild(resultDiv);
        }
    </script>
</body>
</html>
