<!DOCTYPE html>
<html>
<head>
    <title>PlanForge Dependency Cloning Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .test-result { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .debug { background: #fff3cd; color: #856404; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>PlanForge Dependency Cloning Debug Test</h1>
    <div id="test-results"></div>

    <script src="../src/js/model.js"></script>
    <script>
        // Test the dependency cloning in detail
        function runTests() {
            const results = document.getElementById('test-results');
            results.innerHTML = '';

            // Test 1: Create initial scenario with dependencies
            const state = window.PlanForgeModel.createInitialState();
            const now = window.PlanForgeModel.today();
            
            const i1 = window.PlanForgeModel.addInitiative(state, { 
                name: 'Task 1', 
                start: now, 
                end: window.PlanForgeModel.addDays(now, 5) 
            });
            const i2 = window.PlanForgeModel.addInitiative(state, { 
                name: 'Task 2', 
                start: window.PlanForgeModel.addDays(now, 6), 
                end: window.PlanForgeModel.addDays(now, 10) 
            });
            
            // Create dependency
            window.PlanForgeModel.linkDependency(state, i1, i2);
            
            const originalScenario = state.scenarios[0];
            const originalData = originalScenario.data;
            
            addTestResult('Test 1: Original scenario setup', 
                originalData.dependencies.length === 1, 
                `Original dependencies: ${JSON.stringify(originalData.dependencies)}<br>
                 Original initiatives: ${JSON.stringify(originalData.initiatives.map(i => ({id: i.id, name: i.name})))}`);

            // Test 2: Clone scenario and debug the process
            console.log('Before cloning:', {
                scenarios: state.scenarios.length,
                originalDeps: originalData.dependencies,
                originalInitiatives: originalData.initiatives.map(i => ({id: i.id, name: i.name}))
            });
            
            window.PlanForgeModel.cloneActiveScenario(state);
            
            const clonedScenario = state.scenarios[1];
            const clonedData = clonedScenario.data;
            
            console.log('After cloning:', {
                scenarios: state.scenarios.length,
                clonedDeps: clonedData.dependencies,
                clonedInitiatives: clonedData.initiatives.map(i => ({id: i.id, name: i.name}))
            });
            
            addTestResult('Test 2: Cloned scenario analysis', 
                clonedData.dependencies.length === 1, 
                `Cloned dependencies: ${JSON.stringify(clonedData.dependencies)}<br>
                 Cloned initiatives: ${JSON.stringify(clonedData.initiatives.map(i => ({id: i.id, name: i.name})))}`);

            // Test 3: Verify dependency mapping
            const originalDep = originalData.dependencies[0];
            const clonedDep = clonedData.dependencies[0];
            
            const originalFromItem = originalData.initiatives.find(i => i.id === originalDep.fromId);
            const originalToItem = originalData.initiatives.find(i => i.id === originalDep.toId);
            const clonedFromItem = clonedData.initiatives.find(i => i.id === clonedDep.fromId);
            const clonedToItem = clonedData.initiatives.find(i => i.id === clonedDep.toId);
            
            const mappingCorrect = originalFromItem && originalToItem && clonedFromItem && clonedToItem &&
                                 originalFromItem.name === clonedFromItem.name && 
                                 originalToItem.name === clonedToItem.name;
            
            addTestResult('Test 3: Dependency mapping verification', 
                mappingCorrect, 
                `Original: ${originalFromItem?.name} → ${originalToItem?.name}<br>
                 Cloned: ${clonedFromItem?.name} → ${clonedToItem?.name}<br>
                 IDs different: ${originalDep.fromId !== clonedDep.fromId && originalDep.toId !== clonedDep.toId}`);

            // Test 4: Check if dependencies are visible in timeline rendering
            addDebugInfo('Debug Info', `
                Original Scenario ID: ${originalScenario.id}
                Cloned Scenario ID: ${clonedScenario.id}
                Active Scenario ID: ${state.activeScenarioId}
                
                Original Dependencies Count: ${originalData.dependencies.length}
                Cloned Dependencies Count: ${clonedData.dependencies.length}
                
                Original Initiatives Count: ${originalData.initiatives.length}
                Cloned Initiatives Count: ${clonedData.initiatives.length}
                
                All cloned initiatives have correct scenarioId: ${clonedData.initiatives.every(i => i.scenarioId === clonedScenario.id)}
            `);

            // Test 5: Test switching between scenarios
            window.PlanForgeModel.setActiveScenario(state, originalScenario.id);
            const originalActiveData = window.PlanForgeModel.getActiveData(state);
            
            window.PlanForgeModel.setActiveScenario(state, clonedScenario.id);
            const clonedActiveData = window.PlanForgeModel.getActiveData(state);
            
            addTestResult('Test 5: Scenario switching', 
                originalActiveData.dependencies.length === 1 && clonedActiveData.dependencies.length === 1,
                `Original active deps: ${originalActiveData.dependencies.length}, Cloned active deps: ${clonedActiveData.dependencies.length}`);
        }

        function addTestResult(testName, passed, details) {
            const results = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result ' + (passed ? 'success' : 'error');
            resultDiv.innerHTML = `<strong>${testName}:</strong> ${passed ? 'PASS' : 'FAIL'}<br><small>${details}</small>`;
            results.appendChild(resultDiv);
        }

        function addDebugInfo(title, content) {
            const results = document.getElementById('test-results');
            const debugDiv = document.createElement('div');
            debugDiv.className = 'test-result debug';
            debugDiv.innerHTML = `<strong>${title}:</strong><pre>${content}</pre>`;
            results.appendChild(debugDiv);
        }

        // Run tests when page loads
        runTests();
    </script>
</body>
</html>
