<!DOCTYPE html>
<html>
<head>
    <title>PlanForge Dependency Cloning Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #444; border-radius: 8px; }
        .test-result { margin: 10px 0; padding: 10px; background: #2a2a2a; border-radius: 4px; }
        .success { background: #1e4d2b; color: #4ade80; }
        .error { background: #4d1e1e; color: #f87171; }
        .debug { background: #4d3e1e; color: #fbbf24; }
        pre { background: #1a1a1a; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        button { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        .timeline-container { border: 1px solid #444; border-radius: 8px; margin: 20px 0; }
        canvas { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>PlanForge Dependency Cloning Debug</h1>
        
        <div class="test-section">
            <h3>Test Controls</h3>
            <button onclick="createTestData()">Create Test Data</button>
            <button onclick="cloneScenario()">Clone Scenario</button>
            <button onclick="switchToOriginal()">Switch to Original</button>
            <button onclick="switchToClone()">Switch to Clone</button>
            <button onclick="runTests()">Run Tests</button>
        </div>

        <div class="test-section">
            <h3>Timeline View</h3>
            <div class="timeline-container">
                <canvas id="timeline-canvas" width="800" height="400"></canvas>
            </div>
        </div>

        <div class="test-section">
            <h3>Test Results</h3>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h3>Console Output</h3>
            <div id="console-output"></div>
        </div>
    </div>

    <script src="js/model.js"></script>
    <script src="js/timeline.js"></script>
    <script>
        let state = null;
        let timeline = null;
        let originalScenarioId = null;
        let clonedScenarioId = null;

        // Override console.log to capture output
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            const output = document.getElementById('console-output');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<pre>${args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(' ')}</pre>`;
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
        };

        function createTestData() {
            state = window.PlanForgeModel.createInitialState();
            
            const now = window.PlanForgeModel.today();
            
            // Create test initiatives
            const i1 = window.PlanForgeModel.addInitiative(state, { 
                name: 'Task 1', 
                start: now, 
                end: window.PlanForgeModel.addDays(now, 5),
                level: 'Initiative'
            });
            const i2 = window.PlanForgeModel.addInitiative(state, { 
                name: 'Task 2', 
                start: window.PlanForgeModel.addDays(now, 6), 
                end: window.PlanForgeModel.addDays(now, 10),
                level: 'Initiative'
            });
            
            // Create dependency
            window.PlanForgeModel.linkDependency(state, i1, i2);
            
            originalScenarioId = state.activeScenarioId;
            
            // Initialize timeline
            const canvas = document.getElementById('timeline-canvas');
            timeline = window.PlanForgeTimeline.create(state, canvas);
            
            addTestResult('Test Data Created', true, `Created initiatives: ${i1}, ${i2} with dependency ${i1} → ${i2}`);
            renderTimeline();
        }

        function cloneScenario() {
            if (!state) {
                addTestResult('Clone Scenario', false, 'No test data created yet');
                return;
            }
            
            window.PlanForgeModel.cloneActiveScenario(state);
            clonedScenarioId = state.activeScenarioId;
            
            addTestResult('Scenario Cloned', true, `Cloned scenario ID: ${clonedScenarioId}`);
            renderTimeline();
        }

        function switchToOriginal() {
            if (!state || !originalScenarioId) {
                addTestResult('Switch to Original', false, 'No original scenario available');
                return;
            }
            
            window.PlanForgeModel.setActiveScenario(state, originalScenarioId);
            addTestResult('Switched to Original', true, `Active scenario: ${state.activeScenarioId}`);
            renderTimeline();
        }

        function switchToClone() {
            if (!state || !clonedScenarioId) {
                addTestResult('Switch to Clone', false, 'No cloned scenario available');
                return;
            }
            
            window.PlanForgeModel.setActiveScenario(state, clonedScenarioId);
            addTestResult('Switched to Clone', true, `Active scenario: ${state.activeScenarioId}`);
            renderTimeline();
        }

        function renderTimeline() {
            if (timeline) {
                timeline.render();
            }
        }

        function runTests() {
            if (!state) {
                addTestResult('Run Tests', false, 'No test data created yet');
                return;
            }

            const results = document.getElementById('test-results');
            results.innerHTML = '';

            // Test 1: Check original scenario
            const originalScenario = state.scenarios.find(s => s.id === originalScenarioId);
            const originalData = originalScenario.data;
            
            addTestResult('Original Scenario Check', 
                originalData.dependencies.length === 1, 
                `Dependencies: ${originalData.dependencies.length}, Initiatives: ${originalData.initiatives.length}`);

            // Test 2: Check cloned scenario
            const clonedScenario = state.scenarios.find(s => s.id === clonedScenarioId);
            const clonedData = clonedScenario ? clonedScenario.data : null;
            
            addTestResult('Cloned Scenario Check', 
                clonedData && clonedData.dependencies.length === 1, 
                `Dependencies: ${clonedData ? clonedData.dependencies.length : 0}, Initiatives: ${clonedData ? clonedData.initiatives.length : 0}`);

            // Test 3: Verify dependency mapping
            if (clonedData && clonedData.dependencies.length > 0) {
                const originalDep = originalData.dependencies[0];
                const clonedDep = clonedData.dependencies[0];
                
                const originalFromItem = originalData.initiatives.find(i => i.id === originalDep.fromId);
                const originalToItem = originalData.initiatives.find(i => i.id === originalDep.toId);
                const clonedFromItem = clonedData.initiatives.find(i => i.id === clonedDep.fromId);
                const clonedToItem = clonedData.initiatives.find(i => i.id === clonedDep.toId);
                
                const mappingCorrect = originalFromItem && originalToItem && clonedFromItem && clonedToItem &&
                                     originalFromItem.name === clonedFromItem.name && 
                                     originalToItem.name === clonedToItem.name &&
                                     originalDep.fromId !== clonedDep.fromId && 
                                     originalDep.toId !== clonedDep.toId;
                
                addTestResult('Dependency Mapping Verification', 
                    mappingCorrect, 
                    `Original: ${originalFromItem?.name} → ${originalToItem?.name}<br>
                     Cloned: ${clonedFromItem?.name} → ${clonedToItem?.name}<br>
                     IDs different: ${originalDep.fromId !== clonedDep.fromId && originalDep.toId !== clonedDep.toId}`);
            }

            // Test 4: Check scenario scoping
            const allScenariosValid = state.scenarios.every(scenario => 
                scenario.data.dependencies.every(dep => {
                    const fromItem = scenario.data.initiatives.find(i => i.id === dep.fromId);
                    const toItem = scenario.data.initiatives.find(i => i.id === dep.toId);
                    return fromItem && toItem && 
                           fromItem.scenarioId === scenario.id && 
                           toItem.scenarioId === scenario.id;
                })
            );
            
            addTestResult('Scenario Scoping Check', 
                allScenariosValid, 
                'All dependencies are properly scoped to their scenarios');
        }

        function addTestResult(testName, passed, details) {
            const results = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result ' + (passed ? 'success' : 'error');
            resultDiv.innerHTML = `<strong>${testName}:</strong> ${passed ? 'PASS' : 'FAIL'}<br><small>${details}</small>`;
            results.appendChild(resultDiv);
        }

        // Initialize
        console.log('Debug page loaded. Click "Create Test Data" to start.');
    </script>
</body>
</html>
